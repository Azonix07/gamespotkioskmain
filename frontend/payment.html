<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamespot Kiosk - Payment</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Using the oldest, most compatible Firebase version -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
  <!-- Rest of your CSS remains the same -->
  <style>
    /* All your original CSS styles remain the same */
    /* Global Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Body Styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, #121212, #1e1e2f);
    }

    /* Video Background */
    .video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      filter: brightness(0.6) contrast(1.1);
    }

    /* Overlay Styling */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.75) 0%, rgba(12, 12, 24, 0.9) 100%);
      z-index: 0;
    }

    /* Main Container Styling */
    .main-container {
      z-index: 2;
      position: relative;
      width: 90%;
      max-width: 1100px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      padding: 0 15px;
      height: 100vh;
    }

    /* Left Column - Payment Details */
    .payment-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Right Column - Camera */
    .camera-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
    }

    /* Heading Styling */
    h1 {
      color: rgb(255, 111, 0);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      position: relative;
      display: inline-block;
      margin-bottom: 5px;
    }

    h2 {
      color: white;
      font-size: 1.3rem;
      margin: 10px 0 5px;
      font-weight: 600;
    }

    /* Payment Details */
    .payment-details {
      background: rgba(30, 30, 47, 0.7);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 111, 0, 0.2);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    .detail-value {
      font-weight: 600;
      color: rgb(255, 111, 0);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 111, 0, 0.3);
      font-size: 1.1rem;
    }

    /* Camera Section */
    .camera-container {
      width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgb(255, 111, 0);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      background-color: #000;
      aspect-ratio: 4/3;
    }

    #cameraFeed, #canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* Mirror effect */
    }

    #canvas {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
    }

    .camera-message {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 15px;
      max-width: 80%;
      line-height: 1.3;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Face Frame */
    .face-outline {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      border: 3px dashed rgba(255, 111, 0, 0.7);
      border-radius: 50% 50% 45% 45%;
      box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 15px;
    }

    .face-outline p {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: white;
    }

    /* Button Styling */
    .btn {
      padding: 10px 20px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .btn:hover::after {
      left: 100%;
    }

    .btn-orange {
      background: rgb(255, 111, 0);
    }

    .btn-orange:hover {
      background: #ff6b6b;
      transform: translateY(-3px);
    }

    .btn-gray {
      background: #444;
    }

    .btn-gray:hover {
      background: #666;
      transform: translateY(-3px);
    }

    .btn-disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-disabled:hover {
      transform: none;
    }

    .btn-disabled::after {
      display: none;
    }

    /* Payment Methods - LARGER */
    .payment-methods {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 15px 0;
    }

    .payment-method {
      background: rgba(30, 30, 47, 0.7);
      padding: 20px 30px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 140px;
    }

    .payment-method:hover {
      border-color: rgb(255, 111, 0);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .payment-method.selected {
      border-color: rgb(255, 111, 0);
      background: rgba(255, 111, 0, 0.2);
    }

    .payment-method img {
      height: 60px;
      width: auto;
      margin-bottom: 10px;
    }

    .payment-method-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    /* Status Messages */
    .status-message {
      padding: 8px 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
      font-size: 0.9rem;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #f44336;
      color: #ff9999;
    }

    .success {
      background: rgba(0, 128, 0, 0.2);
      border: 1px solid #4CAF50;
      color: #99ff99;
    }

    .info {
      background: rgba(0, 0, 255, 0.2);
      border: 1px solid #2196F3;
      color: #99ccff;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 111, 0, 0.3);
      border-radius: 50%;
      border-top-color: rgb(255, 111, 0);
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      width: 100%;
      gap: 15px;
    }

    /* UPI QR Modal */
    .qr-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }

    .qr-container {
      background: linear-gradient(145deg, #1e1e2f, #252540);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      padding: 30px;
      position: relative;
      width: 90%;
      max-width: 500px;
      border: 2px solid rgb(255, 111, 0);
      text-align: center;
      animation: modalFadeIn 0.5s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .qr-header {
      margin-bottom: 20px;
    }

    .qr-title {
      color: rgb(255, 111, 0);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .qr-subtitle {
      color: #fff;
      font-size: 1.1rem;
      opacity: 0.8;
    }

    .qr-code-box {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      width: 250px;
      height: 250px;
      margin: 0 auto 20px auto;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .qr-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .qr-fallback {
      font-size: 0.8rem;
      color: #333;
      padding: 10px;
      text-align: center;
      display: none;
    }

    .qr-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 15px;
      z-index: 5;
    }

    .qr-loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 111, 0, 0.3);
      border-top-color: rgb(255, 111, 0);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .qr-details {
      margin: 20px 0;
      color: white;
    }

    .qr-amount {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
    }

    .qr-upi-id {
      background: rgba(255, 111, 0, 0.2);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: rgb(255, 111, 0);
      display: inline-block;
      margin: 10px 0;
      border: 1px dashed rgb(255, 111, 0);
      letter-spacing: 0.5px;
    }

    .qr-instructions {
      font-size: 0.9rem;
      color: white;
      margin: 15px 0;
      opacity: 0.8;
      line-height: 1.5;
    }

    .qr-footer {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      align-items: center;
    }

    .qr-close-btn {
      padding: 12px 25px;
      font-size: 1rem;
      background: #666;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .qr-close-btn:hover {
      background: #888;
      transform: translateY(-2px);
    }

    .waiting-status {
      color: white;
      font-weight: 500;
      font-style: italic;
    }

    /* Test mode indicator */
    .test-mode-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 255, 0, 0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 0, 0.5);
    }
  
    /* Remove blue highlight on Android tablets */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    button, input, textarea, select, a, .btn, [role="button"] {
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    button:focus, button:active, input:focus, input:active, a:focus, a:active {
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Waiting for confirmation overlay */
    .waiting-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }
    
    .waiting-container {
      background: rgba(30, 30, 47, 0.9);
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      border: 2px solid rgb(255, 111, 0);
    }
    
    .waiting-title {
      color: rgb(255, 111, 0);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .waiting-message {
      color: white;
      margin-bottom: 20px;
    }
    
    .waiting-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 111, 0, 0.3);
      border-top-color: rgb(255, 111, 0);
      border-radius: 50%;
      margin: 0 auto 20px auto;
      animation: spin 1s linear infinite;
    }
    
    .waiting-cancel {
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Responsive Adjustments */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
        gap: 15px;
        padding: 20px 15px;
        overflow-y: auto;
        height: auto;
      }
      
      .payment-column, .camera-column {
        max-width: 100%;
      }
      
      h1 {
        font-size: 1.7rem;
      }
      
      h2 {
        font-size: 1.2rem;
        margin: 5px 0;
      }
      
      .camera-container {
        aspect-ratio: 16/9;
        max-height: 200px;
      }
      
      .qr-container {
        padding: 20px;
        width: 95%;
      }
      
      .qr-title {
        font-size: 1.5rem;
      }
      
      .qr-code-box {
        width: 200px;
        height: 200px;
      }
      
      .qr-amount {
        font-size: 1.5rem;
      }
    }

    /* Preloaded QR code for instant display */
    .preloaded-image {
      display: none;
    }
    
    /* Debug panel */
    .debug-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 9999;
      font-size: 10px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .debug-btn {
      padding: 5px;
      background: #333;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
    }

    /* Connection status indicator */
    .connection-status {
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 3px;
      background-color: rgba(0,0,0,0.7);
      color: white;
      display: flex;
      align-items: center;
      z-index: 9999;
    }

    .connection-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .connected {
      background-color: #4CAF50;
      box-shadow: 0 0 5px #4CAF50;
    }

    .disconnected {
      background-color: #f44336;
      box-shadow: 0 0 5px #f44336;
    }

    .reconnecting {
      background-color: #FF9800;
      box-shadow: 0 0 5px #FF9800;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    
    /* Debug log */
    #debug-log {
      position: fixed;
      bottom: 50px;
      right: 10px;
      width: 250px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.8);
      color: #ccc;
      font-family: monospace;
      font-size: 10px;
      padding: 5px;
      border-radius: 4px;
      z-index: 9998;
      display: none;
    }
    
    .log-item {
      margin-bottom: 3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 3px;
    }
  </style>
</head>
<body>
  <!-- Video Background -->
  <video class="video-background" autoplay muted loop>
    <source src="background.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <!-- Overlay -->
  <div class="overlay"></div>
  
  <!-- Debug log -->
  <div id="debug-log"></div>

  <!-- Test Mode Badge -->
  <div class="test-mode-badge">TEST MODE</div>

  <!-- Connection Status -->
  <div class="connection-status">
    <div id="connectionIndicator" class="connection-indicator disconnected"></div>
    <span id="connectionStatus">Connecting...</span>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Column - Payment Details -->
    <div class="payment-column">
      <h1>Complete Payment</h1>
      
      <!-- Payment Details -->
      <div class="payment-details">
        <div class="detail-row">
          <div class="detail-label">Device:</div>
          <div class="detail-value" id="selectedConsole">PS5</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Duration:</div>
          <div class="detail-value" id="selectedDuration">60 minutes</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Players:</div>
          <div class="detail-value" id="selectedPlayers">1 Player</div>
        </div>
        <div class="detail-row total-row">
          <div class="detail-label">Total Amount:</div>
          <div class="detail-value" id="totalAmount">₹130</div>
        </div>
      </div>
      
      <h2>Select Payment Method</h2>
      
      <!-- Payment Methods - Cash and UPI -->
      <div class="payment-methods">
        <div class="payment-method" data-method="cash">
          <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Cash">
          <div class="payment-method-name">Cash</div>
        </div>
        <div class="payment-method" data-method="upi">
          <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI">
          <div class="payment-method-name">UPI</div>
        </div>
      </div>
      
      <!-- Status Message -->
      <div id="statusMessage" class="status-message info" style="display: none;"></div>
      
      <!-- Navigation Buttons -->
      <div class="nav-buttons">
        <button class="btn btn-gray" id="backBtn">Back</button>
        <button class="btn btn-orange btn-disabled" id="payBtn" disabled>Pay Now</button>
      </div>
    </div>
    
    <!-- Right Column - Camera -->
    <div class="camera-column">
      <h2>Verification Photo</h2>
      <p style="font-size: 0.9rem; margin-bottom: 10px;">Position your face in the frame for verification</p>
      
      <!-- Camera Section -->
      <div class="camera-container">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="face-outline">
          <p>Position your face here</p>
        </div>
        
        <!-- Camera loading message -->
        <div class="camera-overlay" id="cameraOverlay">
          <div class="camera-message">
            Camera activating... <div class="loading-spinner" style="display: inline-block;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UPI QR Code Modal -->
  <div id="qrModal" class="qr-modal">
    <div class="qr-container">
      <div class="qr-header">
        <div class="qr-title">UPI Payment</div>
        <div class="qr-subtitle">Scan with any UPI app to pay</div>
      </div>
      
      <div class="qr-code-box">
        <img id="qrCodeImage" class="qr-image" src="" alt="UPI QR Code">
        <div id="qrLoading" class="qr-loading">
          <div class="qr-loading-spinner"></div>
        </div>
        <div class="qr-fallback" id="qrFallback">
          Unable to load QR code. Please pay directly to UPI ID below.
        </div>
      </div>
      
      <div class="qr-details">
        <div class="qr-amount">₹<span id="qrAmountDisplay">130</span></div>
        <div class="qr-upi-id" id="qrUpiId">paytm.s15qoa1@pty</div>
        <div class="qr-instructions">
          1. Open any UPI app (GPay, PhonePe, Paytm, etc.)<br>
          2. Scan this QR code or enter UPI ID manually<br>
          3. Enter the amount shown above<br>
          4. Complete payment in your UPI app and wait
        </div>
      </div>
      
      <div class="qr-footer">
        <button id="qrCloseBtn" class="qr-close-btn">Cancel</button>
        <div id="qrWaitingText" style="display: none;">
          <span class="waiting-status">Waiting for payment confirmation</span>
          <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; margin-left: 8px; vertical-align: middle;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Waiting for confirmation overlay -->
  <div id="waitingOverlay" class="waiting-overlay">
    <div class="waiting-container">
      <div class="waiting-spinner"></div>
      <div class="waiting-title">Payment Pending</div>
      <div class="waiting-message">Waiting for payment confirmation...</div>
      <button id="waitingCancelBtn" class="waiting-cancel">Cancel</button>
    </div>
  </div>
  
  <!-- Preloaded image for QR codes -->
  <div class="preloaded-image">
    <img id="preloadedQR" src="">
  </div>
  
  <!-- Debug Panel -->
  <div class="debug-panel">
    <button id="skipCameraBtn" class="debug-btn">Skip Camera</button>
    <button id="restartFirebaseBtn" class="debug-btn">Restart Firebase</button>
    <button id="restartCameraBtn" class="debug-btn">Restart Camera</button>
    <button id="testAlertBtn" class="debug-btn">Test Alert</button>
    <button id="showLogBtn" class="debug-btn">Show Log</button>
    <button id="clearDbBtn" class="debug-btn">Clear DB</button>
  </div>

  <script>
    // Debug logging system
    const debugLog = document.getElementById('debug-log');
    let logVisible = false;
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      console.log(`[${time}] [${type}] ${message}`);
      
      // Add to visual log
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.textContent = `[${time}] ${message}`;
      debugLog.appendChild(logItem);
      
      // Limit log items
      if (debugLog.children.length > 50) {
        debugLog.removeChild(debugLog.children[0]);
      }
      
      // Auto-scroll to bottom
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    document.getElementById('showLogBtn').addEventListener('click', function() {
      logVisible = !logVisible;
      debugLog.style.display = logVisible ? 'block' : 'none';
      this.textContent = logVisible ? 'Hide Log' : 'Show Log';
    });
    
    // Show status message helper function
    function showStatusMessage(message, type) {
      const statusMessage = document.getElementById('statusMessage');
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = 'block';
      
      log(message, type);
      
      // Hide after 5 seconds
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    // Global variables
    let stream = null;
    let selectedPaymentMethod = null;
    const upiId = "paytm.s15qoa1@pty";
    let currentPaymentId = null;
    let database = null;
    let firebaseInitialized = false;
    let cameraInitialized = false;
    
    // DOM elements
    const cameraFeed = document.getElementById('cameraFeed');
    const canvas = document.getElementById('canvas');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const payBtn = document.getElementById('payBtn');
    const backBtn = document.getElementById('backBtn');
    const connectionIndicator = document.getElementById('connectionIndicator');
    const connectionStatus = document.getElementById('connectionStatus');
    
    // Initialize Firebase (using more basic approach)
    function initFirebase() {
      try {
        log("Initializing Firebase...");
        connectionStatus.textContent = "Initializing Firebase...";
        
        if (window.firebase) {
          // Initialize Firebase if not already done
          if (!firebaseInitialized) {
            const config = {
              apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
              authDomain: "gamespotkiosk.firebaseapp.com",
              databaseURL: "https://gamespotkiosk-default-rtdb.asia-southeast1.firebasedatabase.app",
              projectId: "gamespotkiosk",
              storageBucket: "gamespotkiosk.appspot.com",
              messagingSenderId: "537976874541",
              appId: "1:537976874541:web:9e847488e9fc6b78913aa4"
            };
            
            firebase.initializeApp(config);
            database = firebase.database();
            firebaseInitialized = true;
            log("Firebase initialized successfully");
            
            // Set up connection monitoring
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
              const isConnected = snap.val() === true;
              
              connectionIndicator.className = isConnected ? 
                "connection-indicator connected" : "connection-indicator disconnected";
                
              connectionStatus.textContent = isConnected ? "Connected" : "Disconnected";
              
              log(isConnected ? "Connected to Firebase" : "Disconnected from Firebase", 
                 isConnected ? "success" : "error");
                 
              if (!isConnected) {
                // Try to reconnect after a delay
                setTimeout(() => {
                  connectionIndicator.className = "connection-indicator reconnecting";
                  connectionStatus.textContent = "Reconnecting...";
                  
                  // Force reconnection
                  try {
                    database.goOnline();
                    log("Forcing Firebase reconnection", "info");
                  } catch (e) {
                    log("Error forcing reconnection: " + e.message, "error");
                  }
                }, 3000);
              }
            });
            
            return true;
          } else {
            log("Firebase already initialized", "info");
            return true;
          }
        } else {
          log("Firebase library not loaded", "error");
          connectionStatus.textContent = "Firebase library not loaded";
          return false;
        }
      } catch (error) {
        log("Firebase initialization error: " + error.message, "error");
        connectionStatus.textContent = "Firebase init error";
        return false;
      }
    }
    
    // Initialize camera with multiple fallback strategies
    async function initCamera() {
      if (cameraInitialized && stream && stream.active) {
        log("Camera already initialized and active", "info");
        return true;
      }
      
      cameraOverlay.style.display = 'flex';
      cameraOverlay.querySelector('.camera-message').innerHTML = 
        'Camera activating... <div class="loading-spinner" style="display: inline-block;"></div>';
      
      log("Initializing camera...");
      
      try {
        // Strategy 1: Try with very basic settings first
        try {
          log("Trying camera with basic settings");
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          
          cameraFeed.srcObject = stream;
          cameraFeed.onloadedmetadata = () => {
            cameraOverlay.style.display = 'none';
            cameraInitialized = true;
            enablePaymentButtons();
            log("Camera initialized successfully with basic settings", "success");
          };
          return true;
        } catch (err1) {
          log("Basic camera settings failed: " + err1.message, "error");
          
          // Strategy 2: Try with specific low resolution
          try {
            log("Trying camera with low resolution settings");
            stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 320 },
                height: { ideal: 240 },
                facingMode: "user"
              }
            });
            
            cameraFeed.srcObject = stream;
            cameraFeed.onloadedmetadata = () => {
              cameraOverlay.style.display = 'none';
              cameraInitialized = true;
              enablePaymentButtons();
              log("Camera initialized with low resolution", "success");
            };
            return true;
          } catch (err2) {
            log("Low resolution camera failed: " + err2.message, "error");
            
            // Strategy 3: Try with environment camera
            try {
              log("Trying with environment camera");
              stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
              });
              
              cameraFeed.srcObject = stream;
              cameraFeed.onloadedmetadata = () => {
                cameraOverlay.style.display = 'none';
                cameraInitialized = true;
                enablePaymentButtons();
                log("Camera initialized with environment camera", "success");
              };
              return true;
            } catch (err3) {
              throw new Error("All camera initialization attempts failed");
            }
          }
        }
      } catch (error) {
        log("Camera initialization failed: " + error.message, "error");
        
        // Update UI to allow proceeding without camera
        cameraOverlay.innerHTML = `
          <div class="camera-message">
            Camera error: ${error.message}<br>
            <button class="btn btn-orange" onclick="initCamera()">Retry Camera</button>
            <button class="btn btn-gray" onclick="skipCamera()">Continue Without Camera</button>
          </div>
        `;
        
        showStatusMessage("Camera error. You can continue without it.", "error");
        return false;
      }
    }
    
    // Function to skip camera requirement
    function skipCamera() {
      log("Proceeding without camera", "info");
      
      cameraOverlay.innerHTML = `
        <div class="camera-message">
          Continuing without camera
        </div>
      `;
      
      // Enable buttons even without camera
      enablePaymentButtons();
      showStatusMessage("Proceeding without camera. Select a payment method.", "info");
    }
    
    document.getElementById('skipCameraBtn').addEventListener('click', skipCamera);
    
    // Enable payment method selection
    function enablePaymentButtons() {
      document.querySelectorAll('.payment-method').forEach(method => {
        method.onclick = function() {
          // Remove selected class from all methods
          document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
          });
          
          // Add selected class to this method
          this.classList.add('selected');
          
          // Set the selected payment method
          selectedPaymentMethod = this.getAttribute('data-method');
          
          // Enable the pay button
          payBtn.disabled = false;
          payBtn.classList.remove('btn-disabled');
          
          log("Selected payment method: " + selectedPaymentMethod);
          showStatusMessage("Selected: " + selectedPaymentMethod, "info");
        };
      });
    }
    
    // Generate UPI QR code - simplified version
    function generateUpiQrCode(amount) {
      const qrFallback = document.getElementById('qrFallback');
      const qrLoading = document.getElementById('qrLoading');
      const qrCodeImage = document.getElementById('qrCodeImage');
      
      qrLoading.style.display = 'flex';
      qrFallback.style.display = 'none';
      
      // Show UPI ID as text directly for reliability
      document.getElementById('qrUpiId').textContent = upiId;
      document.getElementById('qrAmountDisplay').textContent = amount;
      
      try {
        // Simple direct URL for QR code
        const googleChartUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=upi%3A%2F%2Fpay%3Fpa%3D${encodeURIComponent(upiId)}%26am%3D${amount}%26cu%3DINR&chld=H|1`;
        
        qrCodeImage.onload = function() {
          qrLoading.style.display = 'none';
          log("QR code loaded successfully");
        };
        
        qrCodeImage.onerror = function() {
          log("QR code failed to load", "error");
          qrLoading.style.display = 'none';
          qrFallback.style.display = 'block';
          qrFallback.innerHTML = `
            <strong>Direct Payment</strong><br>
            Please pay ₹${amount} to:<br>
            <strong>${upiId}</strong><br>
            using any UPI app
          `;
        };
        
        qrCodeImage.src = googleChartUrl;
      } catch (error) {
        log("Error generating QR code: " + error.message, "error");
        qrLoading.style.display = 'none';
        qrFallback.style.display = 'block';
        qrFallback.innerHTML = `
          <strong>Direct Payment</strong><br>
          Please pay ₹${amount} to:<br>
          <strong>${upiId}</strong><br>
          using any UPI app
        `;
      }
    }

    // Initialize payment details from local storage
    function initPaymentDetails() {
      try {
        // Get console information
        const consoleName = localStorage.getItem('selectedConsole') || 'PS5';
        
        // Get duration information
        const duration = localStorage.getItem('selectedDuration') || '60';
        const durationMin = parseInt(duration);
        
        // Format duration display
        let durationDisplay;
        if (durationMin === 30) {
          durationDisplay = "30 min";
        } else if (durationMin === 60) {
          durationDisplay = "1 hour";
        } else if (durationMin === 90) {
          durationDisplay = "1.5 hour";
        } else if (durationMin === 120) {
          durationDisplay = "2 hour";
        } else {
          durationDisplay = `${durationMin} minutes`;
        }
        
        // Get player count
        const players = localStorage.getItem('selectedControllers') || '1';
        
        // Get total price
        const totalPrice = localStorage.getItem('totalPrice') || '130';

        // Update UI
        document.getElementById('selectedConsole').textContent = consoleName;
        document.getElementById('selectedDuration').textContent = durationDisplay;
        document.getElementById('selectedPlayers').textContent = `${players} Player${players > 1 ? 's' : ''}`;
        document.getElementById('totalAmount').textContent = `₹${totalPrice}`;
        document.getElementById('qrAmountDisplay').textContent = totalPrice;
        document.getElementById('qrUpiId').textContent = upiId;
        
        log("Payment details loaded successfully");
      } catch (error) {
        log("Error loading payment details: " + error.message, "error");
      }
    }
    
    // Capture photo function - with error handling
    function capturePhoto() {
      try {
        // If no camera stream, return null
        if (!stream || !stream.active) {
          log("Cannot capture photo - no active camera stream");
          return null;
        }
        
        const context = canvas.getContext('2d');
        
        // Make sure the video is ready
        if (cameraFeed.videoWidth === 0 || cameraFeed.videoHeight === 0) {
          log("Cannot capture photo - video not ready");
          return null; // Camera not ready yet
        }
        
        // Set canvas dimensions
        canvas.width = cameraFeed.videoWidth * 0.5;  // 50% of original size
        canvas.height = cameraFeed.videoHeight * 0.5;
        
        // Draw the video frame to the canvas (and flip it horizontally)
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(cameraFeed, 0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight, 
                       0, 0, canvas.width, canvas.height);
        
        // Return the data URL of the image
        return canvas.toDataURL('image/jpeg', 0.7);
      } catch (err) {
        log("Error capturing photo: " + err.message, "error");
        return null;
      }
    }

    // Handle payment initiation
    payBtn.addEventListener('click', async () => {
      if (!selectedPaymentMethod) {
        showStatusMessage('Please select a payment method first.', 'error');
        return;
      }
      
      // Handle based on payment method
      if (selectedPaymentMethod === 'upi') {
        log("UPI payment selected - showing QR code");
        
        // Get amount
        const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
        
        // Show QR code modal
        const qrModal = document.getElementById('qrModal');
        qrModal.style.display = 'flex';
        
        // Generate QR code
        generateUpiQrCode(amount);
        
        // Create payment in Firebase
        if (firebaseInitialized && database) {
          try {
            // Create payment data
            const consoleName = document.getElementById('selectedConsole').textContent;
            const durationText = document.getElementById('selectedDuration').textContent;
            const players = document.getElementById('selectedPlayers').textContent.split(' ')[0];
            
            // Extract minutes from duration text
            let minutes;
            if (durationText.includes('min')) {
              minutes = parseInt(durationText.match(/\d+/)[0]);
            } else if (durationText.includes('hour')) {
              if (durationText.includes('1.5')) {
                minutes = 90;
              } else {
                minutes = parseInt(durationText.match(/\d+/)[0]) * 60;
              }
            }
            
            const paymentId = `payment-${Date.now()}`;
            const paymentData = {
              id: paymentId,
              console: consoleName,
              minutes: minutes,
              method: 'upi',
              players: parseInt(players),
              amount: parseInt(amount),
              createdAt: new Date().toISOString(),
              status: 'pending'
            };
            
            // Send to Firebase
            await database.ref(`pendingPayments/${paymentId}`).set(paymentData);
            log("Payment request sent to Firebase: " + paymentId, "success");
            
            // Show waiting status
            document.getElementById('qrWaitingText').style.display = 'block';
            
            // Set up listener for confirmation
            setupPaymentListener(paymentId);
          } catch (error) {
            log("Error creating payment: " + error.message, "error");
            showStatusMessage("Error creating payment. Try again.", "error");
          }
        } else {
          log("Firebase not connected, cannot create payment", "error");
          showStatusMessage("Not connected to payment system", "error");
        }
      } else {
        // Handle cash payment - simple direct processing
        log("Cash payment selected - processing directly");
        
        // Disable button and show loading state
        payBtn.disabled = true;
        payBtn.innerHTML = 'Processing <div class="loading-spinner"></div>';
        
        // Get payment details
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
        
        // Extract duration in minutes
        let durationMin = 60;
        if (durationText.includes('min')) {
          durationMin = parseInt(durationText.match(/\d+/)[0]);
        } else if (durationText.includes('hour')) {
          if (durationText.includes('1.5')) {
            durationMin = 90;
          } else {
            durationMin = parseInt(durationText.match(/\d+/)[0]) * 60;
          }
        }
        
        // Create booking object
        const endTime = Date.now() + (durationMin * 60 * 1000);
        const players = document.getElementById('selectedPlayers').textContent.split(' ')[0];
        
        const booking = {
          console: consoleName,
          endTime: endTime,
          minutes: durationMin,
          method: 'cash',
          players: parseInt(players),
          amount: amount
        };
        
        // Capture photo if possible
        const photoDataUrl = capturePhoto();
        if (photoDataUrl) {
          // Store the photo locally
          try {
            const photosJSON = localStorage.getItem('userPhotos') || '{}';
            const photos = JSON.parse(photosJSON);
            photos[`${consoleName}-${endTime}`] = photoDataUrl;
            localStorage.setItem('userPhotos', JSON.stringify(photos));
          } catch (e) {
            log("Error storing photo: " + e.message, "error");
          }
        }
        
        // Store booking in localStorage
        try {
          // Also store directly in consoleBookings
          const bookingsJSON = localStorage.getItem('consoleBookings') || '[]';
          let bookings = JSON.parse(bookingsJSON);
          
          // Remove any existing booking for this console
          bookings = bookings.filter(b => b.console !== consoleName);
          
          // Add the new booking
          bookings.push(booking);
          
          // Save updated bookings
          localStorage.setItem('consoleBookings', JSON.stringify(bookings));
          localStorage.setItem('newBooking', JSON.stringify(booking));
          
          log("Booking saved successfully", "success");
          showStatusMessage("Payment successful! Redirecting...", "success");
          
          // Stop camera stream
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          // Redirect after delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        } catch (error) {
          log("Error saving booking: " + error.message, "error");
          showStatusMessage("Error saving booking. Please try again.", "error");
          
          // Reset button state
          payBtn.disabled = false;
          payBtn.innerHTML = 'Pay Now';
        }
      }
    });

    // Set up payment confirmation listener
    function setupPaymentListener(paymentId) {
      if (!firebaseInitialized || !database) {
        log("Cannot setup payment listener - Firebase not initialized", "error");
        return;
      }
      
      log("Setting up payment listener for ID: " + paymentId);
      currentPaymentId = paymentId;
      
      // Listen for confirmation
      const confirmedRef = database.ref(`confirmedPayments/${paymentId}`);
      confirmedRef.on('value', snapshot => {
        try {
          if (snapshot.exists()) {
            log("Payment confirmed: " + paymentId, "success");
            
            // Process successful payment
            processSuccessfulPayment();
          }
        } catch (e) {
          log("Error in confirmation listener: " + e.message, "error");
        }
      });
      
      // Listen for cancellation
      const canceledRef = database.ref(`canceledPayments/${paymentId}`);
      canceledRef.on('value', snapshot => {
        try {
          if (snapshot.exists()) {
            log("Payment canceled: " + paymentId, "info");
            
            // Hide QR modal
            document.getElementById('qrModal').style.display = 'none';
            
            // Show message
            showStatusMessage("Payment was canceled", "info");
            
            // Reset button
            payBtn.disabled = false;
            payBtn.innerHTML = 'Pay Now';
            
            // Clear payment ID
            currentPaymentId = null;
          }
        } catch (e) {
          log("Error in cancellation listener: " + e.message, "error");
        }
      });
      
      // Also do periodic checks as fallback
      const checkInterval = setInterval(() => {
        if (!currentPaymentId) {
          clearInterval(checkInterval);
          return;
        }
        
        log("Periodic check for payment: " + paymentId);
        
        // Check confirmation status
        database.ref(`confirmedPayments/${paymentId}`).once('value')
          .then(snapshot => {
            if (snapshot.exists()) {
              log("Payment confirmed via periodic check", "success");
              clearInterval(checkInterval);
              processSuccessfulPayment();
            }
          })
          .catch(err => {
            log("Error in periodic check: " + err.message, "error");
          });
      }, 10000); // Every 10 seconds
    }
    
    // Process successful payment
    function processSuccessfulPayment() {
      try {
        // Hide QR modal
        document.getElementById('qrModal').style.display = 'none';
        
        // Get payment details
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
        
        // Extract duration in minutes
        let durationMin = 60;
        if (durationText.includes('min')) {
          durationMin = parseInt(durationText.match(/\d+/)[0]);
        } else if (durationText.includes('hour')) {
          if (durationText.includes('1.5')) {
            durationMin = 90;
          } else {
            durationMin = parseInt(durationText.match(/\d+/)[0]) * 60;
          }
        }
        
        // Create booking object
        const endTime = Date.now() + (durationMin * 60 * 1000);
        const players = document.getElementById('selectedPlayers').textContent.split(' ')[0];
        
        const booking = {
          console: consoleName,
          endTime: endTime,
          minutes: durationMin,
          method: 'upi',
          players: parseInt(players),
          amount: amount
        };
        
        // Capture photo if possible
        const photoDataUrl = capturePhoto();
        if (photoDataUrl) {
          // Store the photo locally
          try {
            const photosJSON = localStorage.getItem('userPhotos') || '{}';
            const photos = JSON.parse(photosJSON);
            photos[`${consoleName}-${endTime}`] = photoDataUrl;
            localStorage.setItem('userPhotos', JSON.stringify(photos));
          } catch (e) {
            log("Error storing photo: " + e.message, "error");
          }
        }
        
        // Store booking in localStorage
        try {
          // Also store directly in consoleBookings
          const bookingsJSON = localStorage.getItem('consoleBookings') || '[]';
          let bookings = JSON.parse(bookingsJSON);
          
          // Remove any existing booking for this console
          bookings = bookings.filter(b => b.console !== consoleName);
          
          // Add the new booking
          bookings.push(booking);
          
          // Save updated bookings
          localStorage.setItem('consoleBookings', JSON.stringify(bookings));
          localStorage.setItem('newBooking', JSON.stringify(booking));
          
          log("Booking saved successfully", "success");
          showStatusMessage("Payment successful! Redirecting...", "success");
          
          // Stop camera stream
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          // Redirect after delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        } catch (error) {
          log("Error saving booking: " + error.message, "error");
          showStatusMessage("Error saving booking. Please try again.", "error");
        }
      } catch (error) {
        log("Error processing payment: " + error.message, "error");
        showStatusMessage("Error processing payment. Please try again.", "error");
      }
    }
    
    // Handle cancel button in QR modal
    document.getElementById('qrCloseBtn').addEventListener('click', () => {
      const qrModal = document.getElementById('qrModal');
      qrModal.style.display = 'none';
      
      // If there's an active payment, cancel it
      if (currentPaymentId && firebaseInitialized && database) {
        log("Canceling payment: " + currentPaymentId);
        
        // Remove from pendingPayments
        database.ref(`pendingPayments/${currentPaymentId}`).remove()
          .then(() => {
            log("Payment request canceled successfully");
            currentPaymentId = null;
          })
          .catch(error => {
            log("Error canceling payment: " + error.message, "error");
          });
      }
    });
    
    // Handle back button
    backBtn.addEventListener('click', () => {
      // Stop camera stream if active
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      // Navigate back
      window.location.href = 'duration.html';
    });
    
    // Test alert button
    document.getElementById('testAlertBtn').addEventListener('click', () => {
      if (!firebaseInitialized || !database) {
        showStatusMessage("Firebase not initialized. Cannot send test alert.", "error");
        return;
      }
      
      const testId = 'test-' + Date.now();
      const testData = {
        id: testId,
        console: 'TEST PS5',
        minutes: 30,
        method: 'upi',
        players: 1,
        amount: 100,
        createdAt: new Date().toISOString(),
        status: 'pending'
      };
      
      log("Sending test payment: " + testId);
      
      database.ref(`pendingPayments/${testId}`).set(testData)
        .then(() => {
          log("Test payment sent successfully", "success");
          showStatusMessage("Test payment sent!", "success");
        })
        .catch(error => {
          log("Error sending test payment: " + error.message, "error");
          showStatusMessage("Error sending test payment", "error");
        });
    });
    
    // Clear DB button
    document.getElementById('clearDbBtn').addEventListener('click', () => {
      if (!firebaseInitialized || !database) {
        showStatusMessage("Firebase not initialized. Cannot clear DB.", "error");
        return;
      }
      
      if (confirm("Clear all pending payments?")) {
        database.ref("pendingPayments").remove()
          .then(() => {
            log("Pending payments cleared successfully", "success");
            showStatusMessage("Pending payments cleared", "success");
          })
          .catch(error => {
            log("Error clearing payments: " + error.message, "error");
            showStatusMessage("Error clearing payments", "error");
          });
      }
    });
    
    // Restart camera button
    document.getElementById('restartCameraBtn').addEventListener('click', () => {
      // Stop current stream if it exists
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      // Clear video source
      cameraFeed.srcObject = null;
      
      // Reset initialized flag
      cameraInitialized = false;
      
      // Try to initialize again
      setTimeout(initCamera, 500);
    });
    
    // Restart Firebase button
    document.getElementById('restartFirebaseBtn').addEventListener('click', () => {
      log("Manually restarting Firebase connection");
      
      // If already initialized, try to go online
      if (firebaseInitialized && database) {
        try {
          database.goOnline();
          connectionIndicator.className = "connection-indicator reconnecting";
          connectionStatus.textContent = "Reconnecting...";
          log("Forced Firebase reconnection", "info");
        } catch (e) {
          log("Error forcing reconnection: " + e.message, "error");
        }
      } else {
        // Try to initialize from scratch
        initFirebase();
      }
    });
    
    // Initialize on page load
    window.onload = function() {
      log("Page loaded - 2025-08-06 12:05:29", "info");
      
      // Load payment details
      initPaymentDetails();
      
      // Initialize Firebase
      setTimeout(initFirebase, 500);
      
      // Initialize camera after a short delay
      setTimeout(initCamera, 1000);
      
      // Show instructions
      showStatusMessage("Select a payment method when ready", "info");
    };
  </script>
</body>
</html>
