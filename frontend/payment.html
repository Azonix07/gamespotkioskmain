<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamespot Kiosk - Payment</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* Global Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Body Styling - Enhanced gradient background instead of video */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, #121212, #1e1e2f, #252540);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Overlay Styling */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%);
      z-index: 0;
    }

    /* Main Container Styling */
    .main-container {
      z-index: 2;
      position: relative;
      width: 90%;
      max-width: 1100px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      padding: 0 15px;
      height: 100vh;
    }

    /* Left Column - Payment Details */
    .payment-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Right Column - Camera */
    .camera-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
    }

    /* Heading Styling */
    h1 {
      color: rgb(255, 111, 0);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      position: relative;
      display: inline-block;
      margin-bottom: 5px;
    }

    h2 {
      color: white;
      font-size: 1.3rem;
      margin: 10px 0 5px;
      font-weight: 600;
    }

    /* Payment Details */
    .payment-details {
      background: rgba(30, 30, 47, 0.7);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 111, 0, 0.2);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    .detail-value {
      font-weight: 600;
      color: rgb(255, 111, 0);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 111, 0, 0.3);
      font-size: 1.1rem;
    }

    /* Camera Section */
    .camera-container {
      width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgb(255, 111, 0);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      background-color: #000;
      aspect-ratio: 4/3;
    }

    #cameraFeed, #canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* Mirror effect */
    }

    #canvas {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
    }

    .camera-message {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 15px;
      max-width: 80%;
      line-height: 1.3;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Face Frame */
    .face-outline {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      border: 3px dashed rgba(255, 111, 0, 0.7);
      border-radius: 50% 50% 45% 45%;
      box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 15px;
    }

    .face-outline p {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: white;
    }

    /* Button Styling */
    .btn {
      padding: 10px 20px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .btn:hover::after {
      left: 100%;
    }

    .btn-orange {
      background: rgb(255, 111, 0);
    }

    .btn-orange:hover {
      background: #ff6b6b;
      transform: translateY(-3px);
    }

    .btn-gray {
      background: #444;
    }

    .btn-gray:hover {
      background: #666;
      transform: translateY(-3px);
    }

    .btn-disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-disabled:hover {
      transform: none;
    }

    .btn-disabled::after {
      display: none;
    }

    /* Payment Methods - LARGER */
    .payment-methods {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 15px 0;
    }

    .payment-method {
      background: rgba(30, 30, 47, 0.7);
      padding: 20px 30px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 140px;
    }

    .payment-method:hover {
      border-color: rgb(255, 111, 0);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .payment-method.selected {
      border-color: rgb(255, 111, 0);
      background: rgba(255, 111, 0, 0.2);
    }

    .payment-method img {
      height: 60px;
      width: auto;
      margin-bottom: 10px;
    }

    .payment-method-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    /* Status Messages */
    .status-message {
      padding: 8px 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
      font-size: 0.9rem;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #f44336;
      color: #ff9999;
    }

    .success {
      background: rgba(0, 128, 0, 0.2);
      border: 1px solid #4CAF50;
      color: #99ff99;
    }

    .info {
      background: rgba(0, 0, 255, 0.2);
      border: 1px solid #2196F3;
      color: #99ccff;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 111, 0, 0.3);
      border-radius: 50%;
      border-top-color: rgb(255, 111, 0);
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      width: 100%;
      gap: 15px;
    }

    /* UPI QR Modal */
    .qr-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }

    .qr-container {
      background: linear-gradient(145deg, #1e1e2f, #252540);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      padding: 30px;
      position: relative;
      width: 90%;
      max-width: 500px;
      border: 2px solid rgb(255, 111, 0);
      text-align: center;
      animation: modalFadeIn 0.5s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .qr-header {
      margin-bottom: 20px;
    }

    .qr-title {
      color: rgb(255, 111, 0);
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .qr-subtitle {
      color: #fff;
      font-size: 1.1rem;
      opacity: 0.8;
    }

    .qr-code-box {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      width: 250px;
      height: 250px;
      margin: 0 auto 20px auto;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .qr-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .qr-fallback {
      font-size: 0.8rem;
      color: #333;
      padding: 10px;
      text-align: center;
      display: none;
    }

    .qr-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 15px;
      z-index: 5;
    }

    .qr-loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 111, 0, 0.3);
      border-top-color: rgb(255, 111, 0);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .qr-details {
      margin: 20px 0;
      color: white;
    }

    .qr-amount {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
    }

    .qr-instructions {
      font-size: 0.9rem;
      color: white;
      margin: 15px 0;
      opacity: 0.8;
      line-height: 1.5;
    }

    .qr-footer {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .qr-close-btn {
      padding: 12px 25px;
      font-size: 1rem;
      background: #666;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .qr-close-btn:hover {
      background: #888;
      transform: translateY(-2px);
    }

    .waiting-status {
      color: white;
      font-weight: 500;
      font-style: italic;
    }

    /* Test mode indicator */
    .test-mode-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 255, 0, 0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 0, 0.5);
    }
  
    /* Remove blue highlight on Android tablets */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    button, input, textarea, select, a, .btn, [role="button"] {
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    button:focus, button:active, input:focus, input:active, a:focus, a:active {
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Waiting for confirmation overlay */
    .waiting-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }
    
    .waiting-container {
      background: rgba(30, 30, 47, 0.9);
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      border: 2px solid rgb(255, 111, 0);
    }
    
    .waiting-title {
      color: rgb(255, 111, 0);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .waiting-message {
      color: white;
      margin-bottom: 20px;
    }
    
    .waiting-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 111, 0, 0.3);
      border-top-color: rgb(255, 111, 0);
      border-radius: 50%;
      margin: 0 auto 20px auto;
      animation: spin 1s linear infinite;
    }
    
    .waiting-cancel {
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Success overlay - ENHANCED DESIGN */
    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0, 60, 0, 0.95) 0%, rgba(0, 40, 0, 0.95) 100%);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.6s ease-out;
    }
    
    .success-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 85%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      transform: translateY(0);
      animation: successPop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes successPop {
      0% { transform: scale(0.8); opacity: 0; }
      40% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .success-check {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #4caf50;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
      position: relative;
      box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
    }
    
    .success-check::before {
      content: '';
      width: 40px;
      height: 20px;
      border-bottom: 6px solid white;
      border-left: 6px solid white;
      transform: rotate(-45deg) translate(5px, -5px);
      display: block;
    }
    
    .success-title {
      font-size: 28px;
      font-weight: 700;
      color: white;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .success-message {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .success-details {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 25px;
    }
    
    .success-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .success-detail-row:last-child {
      border-bottom: none;
    }
    
    .success-detail-label {
      color: rgba(255, 255, 255, 0.7);
      text-align: left;
    }
    
    .success-detail-value {
      color: white;
      font-weight: 600;
      text-align: right;
    }
    
    .success-redirect {
      color: rgba(255, 255, 255, 0.7);
      font-style: italic;
      margin-top: 20px;
    }

    /* Device control badge */
    .device-control-badge {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 128, 128, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 30px;
      font-size: 0.8rem;
      font-weight: bold;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: fadeInUp 0.5s;
    }
    
    .device-control-badge.active {
      display: flex;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Adjustments */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
        gap: 15px;
        padding: 20px 15px;
        overflow-y: auto;
        height: auto;
      }
      
      .payment-column, .camera-column {
        max-width: 100%;
      }
      
      h1 {
        font-size: 1.7rem;
      }
      
      h2 {
        font-size: 1.2rem;
        margin: 5px 0;
      }
      
      .camera-container {
        aspect-ratio: 16/9;
        max-height: 200px;
      }
      
      .qr-container {
        padding: 20px;
        width: 95%;
      }
      
      .qr-title {
        font-size: 1.5rem;
      }
      
      .qr-code-box {
        width: 200px;
        height: 200px;
      }
      
      .qr-amount {
        font-size: 1.5rem;
      }
    }

    /* Preloaded QR code for instant display */
    .preloaded-image {
      display: none;
    }

    /* Skip camera button */
    .skip-camera-btn {
      background: #555;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Overlay -->
  <div class="overlay"></div>

  <!-- Test Mode Badge -->
  <div class="test-mode-badge">TEST MODE</div>
  
  <!-- Device Control Badge (hidden by default) -->
  <div class="device-control-badge" id="deviceControlBadge">
    <div class="loading-spinner" style="width: 12px; height: 12px;"></div>
    <span>Device Control Connected</span>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Column - Payment Details -->
    <div class="payment-column">
      <h1>Complete Payment</h1>
      
      <!-- Payment Details -->
      <div class="payment-details">
        <div class="detail-row">
          <div class="detail-label">Device:</div>
          <div class="detail-value" id="selectedConsole">PS5</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Duration:</div>
          <div class="detail-value" id="selectedDuration">60 minutes</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Players:</div>
          <div class="detail-value" id="selectedPlayers">1 Player</div>
        </div>
        <div class="detail-row total-row">
          <div class="detail-label">Total Amount:</div>
          <div class="detail-value" id="totalAmount">₹130</div>
        </div>
      </div>
      
      <h2>Select Payment Method</h2>
      
      <!-- Payment Methods - Cash and UPI -->
      <div class="payment-methods">
        <div class="payment-method" data-method="cash">
          <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Cash">
          <div class="payment-method-name">Cash</div>
        </div>
        <div class="payment-method" data-method="upi">
          <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI">
          <div class="payment-method-name">UPI</div>
        </div>
      </div>
      
      <!-- Status Message -->
      <div id="statusMessage" class="status-message info" style="display: none;"></div>
      
      <!-- Navigation Buttons -->
      <div class="nav-buttons">
        <button class="btn btn-gray" id="backBtn">Back</button>
        <button class="btn btn-orange btn-disabled" id="payBtn" disabled>Pay Now</button>
      </div>
    </div>
    
    <!-- Right Column - Camera -->
    <div class="camera-column">
      <h2>Verification Photo</h2>
      <p style="font-size: 0.9rem; margin-bottom: 10px;">Position your face in the frame for verification</p>
      
      <!-- Camera Section -->
      <div class="camera-container">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="face-outline">
          <p>Position your face here</p>
        </div>
        
        <!-- Camera loading message -->
        <div class="camera-overlay" id="cameraOverlay">
          <div class="camera-message">
            Camera activating... <div class="loading-spinner" style="display: inline-block;"></div>
            <button class="skip-camera-btn" id="skipCameraBtn">Skip Camera</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UPI QR Code Modal -->
  <div id="qrModal" class="qr-modal">
    <div class="qr-container">
      <div class="qr-header">
        <div class="qr-title">UPI Payment</div>
        <div class="qr-subtitle">Scan with any UPI app to pay</div>
      </div>
      
      <div class="qr-code-box">
        <img id="qrCodeImage" class="qr-image" src="" alt="UPI QR Code">
        <div id="qrLoading" class="qr-loading">
          <div class="qr-loading-spinner"></div>
        </div>
        <div class="qr-fallback" id="qrFallback">
          Unable to load QR code. Please use any UPI app to make payment.
        </div>
      </div>
      
      <div class="qr-details">
        <div class="qr-amount">₹<span id="qrAmountDisplay">130</span></div>
        <div class="qr-instructions">
          1. Open any UPI app (GPay, PhonePe, Paytm, etc.)<br>
          2. Scan this QR code<br>
          3. Enter the amount shown above<br>
          4. Complete payment in your UPI app and wait
        </div>
      </div>
      
      <div class="qr-footer">
        <button id="qrCloseBtn" class="qr-close-btn">Cancel</button>
        <div id="qrWaitingText" style="display: none;">
          <span class="waiting-status">Waiting for payment confirmation</span>
          <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; margin-left: 8px; vertical-align: middle;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Waiting for confirmation overlay -->
  <div id="waitingOverlay" class="waiting-overlay">
    <div class="waiting-container">
      <div class="waiting-spinner"></div>
      <div class="waiting-title">Payment Pending</div>
      <div class="waiting-message">Waiting for payment confirmation...</div>
      <button id="waitingCancelBtn" class="waiting-cancel">Cancel</button>
    </div>
  </div>
  
  <!-- Preloaded image for QR codes -->
  <div class="preloaded-image">
    <img id="preloadedQR" src="">
  </div>

  <script>
    // Firebase Configuration - USING BOTH FIREBASE DATABASES
    // Original Firebase config
    const firebaseConfig1 = {
      apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
      authDomain: "gamespotkiosk.firebaseapp.com",
      databaseURL: "https://gamespotkiosk-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gamespotkiosk",
      storageBucket: "gamespotkiosk.firebasestorage.app",
      messagingSenderId: "537976874541",
      appId: "1:537976874541:web:9e847488e9fc6b78913aa4",
      measurementId: "G-SGD83SS6D1"
    };

    // Second Firebase config
    const firebaseConfig2 = {
      apiKey: "AIzaSyA2kmnE1qCIXhW2OT-ELJ0rcWcEGOU8k_I",
      authDomain: "gamespotkiosk2.firebaseapp.com",
      databaseURL: "https://gamespotkiosk2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gamespotkiosk2",
      storageBucket: "gamespotkiosk2.firebasestorage.app",
      messagingSenderId: "298002512298",
      appId: "1:298002512298:web:6c3b8fc6a60155531d13d3",
      measurementId: "G-W91C2RX9E7"
    };
    
    // HTTPS mode variable
    let httpsMode = window.location.protocol === 'https:';
    let localAccessMode = false;
    
    // Initialize both Firebase apps with error handling
    let firebaseApp1, firebaseApp2;
    let database1, database2;
    
    try {
      // Initialize first Firebase app
      firebaseApp1 = firebase.initializeApp(firebaseConfig1);
      database1 = firebaseApp1.database();
      
      // Initialize second Firebase app with a different name
      firebaseApp2 = firebase.initializeApp(firebaseConfig2, "secondary");
      database2 = firebaseApp2.database();
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    // Global variables
    let stream = null;
    let selectedPaymentMethod = null;
    const upiId = "paytm.s15qoa1@pty";
    let currentPaymentId = null;
    let paymentListeners = {};
    let cameraInitialized = false;
    let deviceControlConnected = false;
    let autoPaymentCheckTimer = null;
    
    // DOM elements
    const cameraFeed = document.getElementById('cameraFeed');
    const canvas = document.getElementById('canvas');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const payBtn = document.getElementById('payBtn');
    const backBtn = document.getElementById('backBtn');
    const statusMessage = document.getElementById('statusMessage');
    const paymentMethods = document.querySelectorAll('.payment-method');
    const skipCameraBtn = document.getElementById('skipCameraBtn');
    const deviceControlBadge = document.getElementById('deviceControlBadge');
    
    // QR Modal elements
    const qrModal = document.getElementById('qrModal');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const qrLoading = document.getElementById('qrLoading');
    const qrFallback = document.getElementById('qrFallback');
    const qrAmountDisplay = document.getElementById('qrAmountDisplay');
    const qrCloseBtn = document.getElementById('qrCloseBtn');
    const qrWaitingText = document.getElementById('qrWaitingText');

    // ULTRA-FAST PS5 Relay Activation - ZERO DELAY VERSION
    function activatePS5(durationMinutes) {
      // IMMEDIATE FEEDBACK - Don't wait for confirmation
      deviceControlBadge.classList.add('active');
      deviceControlBadge.innerHTML = `<span>PS5 #4 Active</span>`;
      deviceControlBadge.style.backgroundColor = "rgba(0, 128, 0, 0.7)";
      
      // Create a high-priority command
      const command = {
        command: "on",
        deviceId: 4,
        timestamp: "2025-08-09 14:42:55", // Updated timestamp
        user: "Azonix07",
        duration: durationMinutes,
        priority: "critical",  // Maximum priority
        immediate: true,
        urgency: "extreme",    // Additional urgency flag
        noDelay: true,         // Tell ESP32 not to delay execution
        rapidExecution: true   // Another speed flag
      };
      
      // PARALLEL STRATEGY: 
      // 1. Send to both databases at once with no waiting
      // 2. Send multiple commands in quick succession
      // 3. Don't wait for responses at all
      
      // Send first command immediately
      sendCommandWithoutWaiting(command);
      
      // Send a second command with slight variation 100ms later (for redundancy)
      setTimeout(() => {
        sendCommandWithoutWaiting({...command, retry: true, retryTimestamp: Date.now()});
      }, 100);
      
      // Return success immediately without waiting
      return Promise.resolve(true);
      
      // Helper function to send commands without waiting
      function sendCommandWithoutWaiting(cmd) {
        // Fire and forget approach - don't wait for promises to resolve
        database1.ref('relayCommands/ps5_4').set(cmd);
        database2.ref('relayCommands/ps5_4').set(cmd);
        
        // Also try with slightly different path in case of cache issues
        database1.ref(`relayCommands/ps5_4_${Date.now()}`).set(cmd);
        database2.ref(`relayCommands/ps5_4_${Date.now()}`).set(cmd);
        
        // Also send direct priority command
        database1.ref('priorityCommands/ps5_4').set(cmd);
        database2.ref('priorityCommands/ps5_4').set(cmd);
      }
    }

    // Device Status Checker Function - Check both databases
    function checkDeviceStatus() {
      // Check status in both databases
      return Promise.all([
        database1.ref('relayStatus/ps5_4').once('value'),
        database2.ref('relayStatus/ps5_4').once('value')
      ])
      .then(([snapshot1, snapshot2]) => {
        // Check if status exists in either database
        if (snapshot1.exists()) {
          const status = snapshot1.val();
          processStatus(status);
          return true;
        } else if (snapshot2.exists()) {
          const status = snapshot2.val();
          processStatus(status);
          return true;
        } else {
          return false;
        }
      })
      .catch(error => {
        console.error("Error checking device status:", error);
        return false;
      });
      
      function processStatus(status) {
        deviceControlConnected = true;
        deviceControlBadge.classList.add('active');
        
        if (status.active) {
          deviceControlBadge.innerHTML = `<span>PS5 #4 Active</span>`;
          deviceControlBadge.style.backgroundColor = "rgba(0, 128, 0, 0.7)";
        } else {
          deviceControlBadge.innerHTML = `<span>PS5 #4 Ready</span>`;
          deviceControlBadge.style.backgroundColor = "rgba(0, 128, 128, 0.7)";
        }
      }
    }
    
    // Initialize payment details from local storage
    function initPaymentDetails() {
      // Get console information
      const consoleName = localStorage.getItem('selectedConsole') || 'PS5';
      
      // Get duration information
      const duration = localStorage.getItem('selectedDuration') || '60';
      const durationMin = parseInt(duration);
      
      // Format duration display
      let durationDisplay;
      if (durationMin === 30) {
        durationDisplay = "30 min";
      } else if (durationMin === 60) {
        durationDisplay = "1 hour";
      } else if (durationMin === 90) {
        durationDisplay = "1.5 hours";
      } else if (durationMin === 120) {
        durationDisplay = "2 hours";
      } else {
        durationDisplay = `${durationMin} minutes`;
      }
      
      // Get player count
      const players = localStorage.getItem('selectedControllers') || '1';
      
      // Get total price
      const totalPrice = localStorage.getItem('totalPrice') || '130';

      // Update UI
      document.getElementById('selectedConsole').textContent = consoleName;
      document.getElementById('selectedDuration').textContent = durationDisplay;
      document.getElementById('selectedPlayers').textContent = `${players} Player${players > 1 ? 's' : ''}`;
      document.getElementById('totalAmount').textContent = `₹${totalPrice}`;
      qrAmountDisplay.textContent = totalPrice;
      
      // Preload QR code
      preloadQRCode(totalPrice);
    }
    
    // Preload QR code
    function preloadQRCode(amount) {
      const payeeName = encodeURIComponent("Gamespot Kiosk");
      const upiPaymentUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${payeeName}&am=${amount}&cu=INR&tn=Gaming%20Session`;
      const googleChartUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(upiPaymentUrl)}&chld=H|1`;
      
      // Set the src to preload
      preloadedQR.src = googleChartUrl;
    }

    // Listen for direct completion from ESP32
    function setupDirectCompleteListener() {
      // Listen on both databases
      database1.ref('directComplete').on('value', snapshot => {
        if (snapshot.exists()) {
          handleDirectCompletionDetection(snapshot.val(), database1);
        }
      });
      
      database2.ref('directComplete').on('value', snapshot => {
        if (snapshot.exists()) {
          handleDirectCompletionDetection(snapshot.val(), database2);
        }
      });
      
      function handleDirectCompletionDetection(completionData, database) {
        // Handle both cases - with or without paymentId
        if (currentPaymentId === completionData.paymentId || !currentPaymentId) {
          // Clear the directComplete node to avoid duplicate processing
          database.ref('directComplete').remove();
          
          // Handle the payment success directly
          handleDirectCompletion();
        } else if (completionData.status === 'completed') {
          // Clear the node anyway
          database.ref('directComplete').remove();
        }
      }
    }

    // Auto-check for payment confirmation (fallback mechanism)
    function startAutoPaymentCheck(paymentId) {
      if (autoPaymentCheckTimer) {
        clearInterval(autoPaymentCheckTimer);
      }

      // Start checking for payment completion
      let checkCount = 0;
      autoPaymentCheckTimer = setInterval(() => {
        checkCount++;
        
        // Check if payment was marked as completed in either database
        Promise.all([
          database1.ref(`confirmedPayments/${paymentId}`).once('value'),
          database2.ref(`confirmedPayments/${paymentId}`).once('value')
        ])
        .then(([snapshot1, snapshot2]) => {
          if (snapshot1.exists() || snapshot2.exists()) {
            clearInterval(autoPaymentCheckTimer);
            autoPaymentCheckTimer = null;
            
            // Handle the successful payment
            handleSuccessfulPayment(null, 'upi', document.getElementById('totalAmount').textContent.replace('₹', ''));
          }
        })
        .catch(err => {
          console.error('Error during auto payment check:', err);
        });
        
        // Stop checking after 5 minutes (60 checks at 5-second intervals)
        if (checkCount >= 60) {
          clearInterval(autoPaymentCheckTimer);
          autoPaymentCheckTimer = null;
        }
      }, 5000); // Check every 5 seconds
    }

    // Handle direct completion from ESP32
    async function handleDirectCompletion() {
      try {
        const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
        
        // Hide QR modal if it's open
        qrModal.style.display = 'none';
        
        // Store booking info
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        
        // Extract number from duration text
        let durationMin;
        if (durationText.includes('min')) {
          durationMin = parseInt(durationText.match(/\d+/)[0]);
        } else if (durationText.includes('hour')) {
          if (durationText.includes('1.5')) {
            durationMin = 90;
          } else {
            durationMin = parseInt(durationText.match(/\d+/)[0]) * 60;
          }
        } else {
          durationMin = parseInt(localStorage.getItem('selectedDuration'));
        }
        
        const players = localStorage.getItem('selectedControllers') || '1';
        
        // Calculate end time for booking
        const endTime = Date.now() + (durationMin * 60 * 1000);
        
        // Get the photo data URL
        const photoDataUrl = capturePhoto();
        
        // Create unique ID for this booking
        const bookingId = `${consoleName}-${endTime}`;
        
        // Store the photo locally
        const photosJSON = localStorage.getItem('userPhotos') || '{}';
        let photos;
        try {
          photos = JSON.parse(photosJSON);
        } catch (e) {
          photos = {};
        }
        photos[bookingId] = photoDataUrl;
        localStorage.setItem('userPhotos', JSON.stringify(photos));
        
        // Store booking in the multi-booking format
        const newBooking = {
          console: consoleName,
          endTime: endTime,
          minutes: durationMin,
          method: selectedPaymentMethod || 'upi',
          players: players,
          amount: amount,
          direct: true, // Flag for direct ESP32 confirmation
          timestamp: "2025-08-09 14:42:55", // Updated timestamp
          user: 'Azonix07' // Updated username
        };
        
        // Use storage event to communicate between tabs
        localStorage.setItem('newBooking', JSON.stringify(newBooking));
        
        // Also store directly in consoleBookings
        const bookingsJSON = localStorage.getItem('consoleBookings') || '[]';
        let bookings = JSON.parse(bookingsJSON);
        
        // Remove any existing booking for this console
        bookings = bookings.filter(b => b.console !== consoleName);
        
        // Add the new booking
        bookings.push(newBooking);
        
        // Save updated bookings
        localStorage.setItem('consoleBookings', JSON.stringify(bookings));
        
        // Activate PS5 #4 via ESP32 using Firebase
        let deviceActivated = false;
        if (deviceControlConnected) {
          // Try to activate the device
          deviceActivated = await activatePS5(durationMin);
        }
        
        // Show enhanced success overlay
        const successOverlay = document.createElement('div');
        successOverlay.className = 'success-overlay';
        
        // Calculate session end time
        const sessionEndDate = new Date(endTime);
        const hours = sessionEndDate.getHours().toString().padStart(2, '0');
        const minutes = sessionEndDate.getMinutes().toString().padStart(2, '0');
        
        successOverlay.innerHTML = `
          <div class="success-container">
            <div class="success-check"></div>
            <div class="success-title">Payment Successful!</div>
            <div class="success-message">Your gaming session has been confirmed.</div>
            
            <div class="success-details">
              <div class="success-detail-row">
                <div class="success-detail-label">Device</div>
                <div class="success-detail-value">${consoleName} #4</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Duration</div>
                <div class="success-detail-value">${durationText}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">End Time</div>
                <div class="success-detail-value">${hours}:${minutes}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Amount Paid</div>
                <div class="success-detail-value">₹${amount}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Device Status</div>
                <div class="success-detail-value">${deviceActivated ? "Powered On" : "Manual Activation Required"}</div>
              </div>
            </div>
            
            <div class="success-redirect">Redirecting to home screen...</div>
          </div>
        `;
        
        document.body.appendChild(successOverlay);
        
        // Stop camera stream
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        
        // Clean up Firebase listeners
        if (currentPaymentId) {
          removePaymentListeners(currentPaymentId);
          currentPaymentId = null;
        }
        
        // Stop auto payment checker if it's running
        if (autoPaymentCheckTimer) {
          clearInterval(autoPaymentCheckTimer);
          autoPaymentCheckTimer = null;
        }
        
        // Redirect to index.html after a delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
        
      } catch (err) {
        console.error('Direct completion processing error:', err);
        showStatusMessage(`Processing error: ${err.message}. Please contact support.`, 'error');
      }
    }
    
    // Skip camera function
    skipCameraBtn.addEventListener('click', function() {
      cameraOverlay.innerHTML = `
        <div class="camera-message">
          Continuing without camera
        </div>
      `;
      
      // Enable payment buttons
      document.querySelectorAll('.payment-method').forEach(method => {
        method.onclick = function() {
          // Remove selected class from all methods
          document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
          });
          
          // Add selected class to this method
          this.classList.add('selected');
          
          // Set the selected payment method
          selectedPaymentMethod = this.getAttribute('data-method');
          
          // Enable the pay button regardless of camera
          payBtn.disabled = false;
          payBtn.classList.remove('btn-disabled');
          
          showStatusMessage(`Selected payment method: ${selectedPaymentMethod}`, 'info');
        };
      });
      
      showStatusMessage('Camera skipped. You can now select a payment method.', 'info');
    });

    // Improved camera initialization for Android compatibility
    async function initCamera() {
      if (cameraInitialized) return;
      
      try {
        // Try with specific constraints for Android
        try {
          stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: "user",
              width: { ideal: 640 },
              height: { ideal: 480 }
            } 
          });
        } catch (initialError) {
          // Try with minimal constraints
          stream = await navigator.mediaDevices.getUserMedia({ 
            video: true
          });
        }
        
        if (!stream) {
          throw new Error("Could not initialize camera stream");
        }
        
        cameraFeed.srcObject = stream;
        
        // Add more reliable event listener for video
        cameraFeed.addEventListener('loadedmetadata', function() {
          cameraOverlay.style.display = 'none';
          cameraInitialized = true;
          
          // Add click events to payment methods
          document.querySelectorAll('.payment-method').forEach(method => {
            method.onclick = function() {
              // Remove selected class from all methods
              document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
              });
              
              // Add selected class to this method
              this.classList.add('selected');
              
              // Set the selected payment method
              selectedPaymentMethod = this.getAttribute('data-method');
              
              // Enable the pay button
              payBtn.disabled = false;
              payBtn.classList.remove('btn-disabled');
              
              showStatusMessage(`Selected payment method: ${selectedPaymentMethod}`, 'info');
            };
          });
          
          showStatusMessage('Camera activated. Select payment method to continue.', 'info');
        });
        
        // Add error handler for video
        cameraFeed.addEventListener('error', function(e) {
          skipCamera("Video error: " + (e.message || "Unknown error"));
        });
        
        // Set timeout for camera initialization
        setTimeout(() => {
          if (!cameraInitialized) {
            skipCamera("Camera initialization timed out");
          }
        }, 8000);
        
      } catch (err) {
        skipCamera(err.message || "Camera not available");
      }
    }
    
    // Helper function to skip camera with a message
    function skipCamera(errorMessage) {
      cameraOverlay.innerHTML = `
        <div class="camera-message">
          Camera error: ${errorMessage}<br>Please allow camera access or click skip.
          <button class="skip-camera-btn" id="skipCameraRetryBtn">Skip Camera</button>
        </div>
      `;
      
      document.getElementById('skipCameraRetryBtn').addEventListener('click', function() {
        cameraOverlay.innerHTML = `
          <div class="camera-message">
            Continuing without camera
          </div>
        `;
        
        // Enable payment buttons even without camera
        document.querySelectorAll('.payment-method').forEach(method => {
          method.onclick = function() {
            // Remove selected class from all methods
            document.querySelectorAll('.payment-method').forEach(m => {
              m.classList.remove('selected');
            });
            
            // Add selected class to this method
            this.classList.add('selected');
            
            // Set the selected payment method
            selectedPaymentMethod = this.getAttribute('data-method');
            
            // Enable the pay button
            payBtn.disabled = false;
            payBtn.classList.remove('btn-disabled');
            
            showStatusMessage(`Selected payment method: ${selectedPaymentMethod}`, 'info');
          };
        });
        
        showStatusMessage('Camera skipped. You can now select a payment method.', 'info');
      });
      
      showStatusMessage(`Camera error: ${errorMessage}. You can skip the camera.`, 'error');
    }

    // Improved capturePhoto function that actually returns the photo data
    function capturePhoto() {
      try {
        if (!stream || !stream.active) {
          return null; // Camera not available
        }
        
        const context = canvas.getContext('2d');
        
        // Make sure the video is ready
        if (cameraFeed.videoWidth === 0 || cameraFeed.videoHeight === 0) {
          return null; // Camera not ready yet
        }
        
        // Set canvas dimensions
        canvas.width = cameraFeed.videoWidth * 0.5;  // 50% of original size
        canvas.height = cameraFeed.videoHeight * 0.5;
        
        // Draw the video frame to the canvas (and flip it horizontally)
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(cameraFeed, 0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight, 
                         0, 0, canvas.width, canvas.height);
        
        // Return the data URL of the image
        return canvas.toDataURL('image/jpeg', 0.7);
      } catch (err) {
        console.error("Error capturing photo:", err);
        return null;
      }
    }
    
    // Generate UPI QR code
    function generateUpiQrCode(amount) {
      qrLoading.style.display = 'flex';
      qrFallback.style.display = 'none';
      
      try {
        // Use the preloaded QR code if available
        if (preloadedQR.complete && preloadedQR.naturalHeight !== 0) {
          qrCodeImage.src = preloadedQR.src;
          qrLoading.style.display = 'none';
          return;
        }
        
        // Generate new QR code
        const payeeName = encodeURIComponent("Gamespot Kiosk");
        const upiPaymentUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${payeeName}&am=${amount}&cu=INR&tn=Gaming%20Session`;
        const googleChartUrl = `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(upiPaymentUrl)}&chld=H|1`;
        
        // Set image source
        qrCodeImage.onload = function() {
          qrLoading.style.display = 'none';
        };
        
        qrCodeImage.onerror = function() {
          qrLoading.style.display = 'none';
          qrFallback.style.display = 'block';
          
          // Try using a backup QR code service
          const backupQrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiPaymentUrl)}`;
          
          qrCodeImage.onload = function() {
            qrFallback.style.display = 'none';
          };
          
          qrCodeImage.onerror = function() {
            qrFallback.style.display = 'block';
          };
          
          qrCodeImage.src = backupQrUrl;
        };
        
        qrCodeImage.src = googleChartUrl;
      } catch (error) {
        qrLoading.style.display = 'none';
        qrFallback.style.display = 'block';
      }
    }

    // Send payment alert to remote admin devices
    async function sendPaymentAlert(method, amount) {
      try {
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        const players = document.getElementById('selectedPlayers').textContent.split(' ')[0];
        
        // Extract minutes from duration text
        let minutes;
        if (durationText.includes('min')) {
          minutes = parseInt(durationText.match(/\d+/)[0]);
        } else if (durationText.includes('hour')) {
          if (durationText.includes('1.5')) {
            minutes = 90;
          } else {
            minutes = parseInt(durationText.match(/\d+/)[0]) * 60;
          }
        }
        
        // Create a pending payment object
        const paymentId = `payment-${Date.now()}`;
        const paymentData = {
          id: paymentId,
          console: consoleName,
          consoleId: 4, // For PS5 #4
          minutes: minutes,
          method: method,
          players: parseInt(players),
          amount: parseInt(amount),
          createdAt: "2025-08-09 14:42:55", // Updated timestamp
          status: 'pending',
          user: 'Azonix07' // Updated username
        };
        
        // Determine which database(s) to send to
        const promises = [];
        
        promises.push(
          database1.ref(`pendingPayments/${paymentId}`).set(paymentData)
            .catch(err => console.error('Error sending payment alert to Firebase 1:', err))
        );
        
        promises.push(
          database2.ref(`pendingPayments/${paymentId}`).set(paymentData)
            .catch(err => console.error('Error sending payment alert to Firebase 2:', err))
        );
        
        // Wait for all promises to resolve
        await Promise.all(promises);
        showStatusMessage('Payment request sent', 'info');
        return paymentId;
      } catch (error) {
        console.error("Error in sendPaymentAlert:", error);
        showStatusMessage('Payment system error', 'error');
        return null;
      }
    }

    // Check for payment confirmation
    function startPaymentConfirmationCheck(paymentId) {
      // Show waiting text in QR modal
      qrWaitingText.style.display = 'block';
      
      // Store current payment ID
      currentPaymentId = paymentId;
      
      // Set up listeners for both databases
      setupConfirmationListeners(database1, paymentId, '1');
      setupConfirmationListeners(database2, paymentId, '2');
      
      // Start backup auto-check mechanism
      startAutoPaymentCheck(paymentId);
      
      function setupConfirmationListeners(db, paymentId, dbName) {
        const confirmedRef = db.ref(`confirmedPayments/${paymentId}`);
        const canceledRef = db.ref(`canceledPayments/${paymentId}`);
        
        // Confirmation listener
        const confirmListenerKey = `confirm_db${dbName}`;
               paymentListeners[confirmListenerKey] = confirmedRef.on('value', snapshot => {
          if (snapshot.exists()) {
            // Payment confirmed
            removePaymentListeners(paymentId);
            
            // Stop auto payment checker if it's running
            if (autoPaymentCheckTimer) {
              clearInterval(autoPaymentCheckTimer);
              autoPaymentCheckTimer = null;
            }
            
            // Check if this is from ESP32
            const paymentData = snapshot.val();
            if (paymentData && paymentData.confirmedBy === 'ESP32-AutoConfirm') {
              handleDirectCompletion();
            } else {
              // Standard confirmation flow
              handleSuccessfulPayment(null, selectedPaymentMethod, document.getElementById('totalAmount').textContent.replace('₹', ''));
            }
          }
        });
        
        // Cancellation listener
        const cancelListenerKey = `cancel_db${dbName}`;
        paymentListeners[cancelListenerKey] = canceledRef.on('value', snapshot => {
          if (snapshot.exists()) {
            // Payment canceled
            removePaymentListeners(paymentId);
            qrModal.style.display = 'none';
            
            // Stop auto payment checker if it's running
            if (autoPaymentCheckTimer) {
              clearInterval(autoPaymentCheckTimer);
              autoPaymentCheckTimer = null;
            }
            
            showStatusMessage('Payment was canceled', 'error');
            payBtn.disabled = false;
            payBtn.innerHTML = 'Pay Now';
            
            currentPaymentId = null;
          }
        });
      }
    }
    
    // Cancel the current payment
    function cancelCurrentPayment() {
      if (currentPaymentId) {
        const promises = [];
        
        promises.push(
          database1.ref(`pendingPayments/${currentPaymentId}`).remove()
            .catch(error => console.error('Error canceling payment in DB1:', error))
        );
        
        promises.push(
          database2.ref(`pendingPayments/${currentPaymentId}`).remove()
            .catch(error => console.error('Error canceling payment in DB2:', error))
        );
        
        // Wait for all operations to complete
        Promise.all(promises)
          .then(() => {
            removePaymentListeners(currentPaymentId);
            qrModal.style.display = 'none';
            
            // Stop auto payment checker if it's running
            if (autoPaymentCheckTimer) {
              clearInterval(autoPaymentCheckTimer);
              autoPaymentCheckTimer = null;
            }
            
            showStatusMessage('Payment request canceled', 'info');
            payBtn.disabled = false;
            payBtn.innerHTML = 'Pay Now';
            
            currentPaymentId = null;
          });
      } else {
        qrModal.style.display = 'none';
      }
    }
    
    // Remove payment listeners
    function removePaymentListeners(paymentId) {
      // Remove listeners from first database
      if (paymentListeners.confirm_db1) {
        database1.ref(`confirmedPayments/${paymentId}`).off('value', paymentListeners.confirm_db1);
      }
      
      if (paymentListeners.cancel_db1) {
        database1.ref(`canceledPayments/${paymentId}`).off('value', paymentListeners.cancel_db1);
      }
      
      // Remove listeners from second database
      if (paymentListeners.confirm_db2) {
        database2.ref(`confirmedPayments/${paymentId}`).off('value', paymentListeners.confirm_db2);
      }
      
      if (paymentListeners.cancel_db2) {
        database2.ref(`canceledPayments/${paymentId}`).off('value', paymentListeners.cancel_db2);
      }
      
      paymentListeners = {};
    }

    // Show QR modal and generate QR code
    function showQrModal() {
      const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
      qrAmountDisplay.textContent = amount;
      
      // Reset UI elements
      qrWaitingText.style.display = 'none';
      
      // Generate and display QR code
      generateUpiQrCode(amount);
      
      // Show modal
      qrModal.style.display = 'flex';
      
      // Send payment alert to remote devices
      sendPaymentAlert('upi', amount)
        .then(paymentId => {
          if (paymentId) {
            // Switch to waiting mode
            qrWaitingText.style.display = 'block';
            
            // Start waiting for confirmation
            startPaymentConfirmationCheck(paymentId);
          } else {
            showStatusMessage('Could not connect to payment system. Please try again.', 'error');
          }
        })
        .catch(err => {
          showStatusMessage('Payment system error. Please try again or use cash.', 'error');
        });
    }
    
    // Handle UPI payment cancellation
    qrCloseBtn.addEventListener('click', function() {
      // Hide modal
      qrModal.style.display = 'none';
      
      // If there's an active payment request, cancel it
      if (currentPaymentId) {
        cancelCurrentPayment();
      }
    });

    // Handle payment - Show QR code for UPI or process cash payment
    payBtn.addEventListener('click', async () => {
      if (!selectedPaymentMethod) {
        showStatusMessage('Please select a payment method first.', 'error');
        return;
      }
      
      // Handle based on payment method
      if (selectedPaymentMethod === 'upi') {
        // Show UPI QR code modal
        showQrModal();
      } else {
        // Handle cash payment
        // Disable button and show loading state
        payBtn.disabled = true;
        payBtn.innerHTML = 'Processing <div class="loading-spinner"></div>';
        
        try {
          // Get payment details
          const consoleName = document.getElementById('selectedConsole').textContent;
          const durationText = document.getElementById('selectedDuration').textContent;
          
          // Extract number from duration text
          let durationMin;
          if (durationText.includes('min')) {
            durationMin = parseInt(durationText.match(/\d+/)[0]);
          } else if (durationText.includes('hour')) {
            if (durationText.includes('1.5')) {
              durationMin = 90;
            } else {
              durationMin = parseInt(durationText.match(/\d+/)[0]) * 60;
            }
          } else {
            throw new Error('Could not determine duration');
          }
          
          const amount = document.getElementById('totalAmount').textContent.replace('₹', '');
          
          // Capture the photo for storage if camera is available
          const photoDataUrl = capturePhoto();
          
          // Wait a bit to simulate processing
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Handle the successful payment - for cash, we don't need remote confirmation
          handleSuccessfulPayment(null, 'cash', amount);
          
        } catch (err) {
          showStatusMessage(`Payment error: ${err.message}. Please try again.`, 'error');
          
          // Reset button state
          payBtn.innerHTML = 'Pay Now';
          payBtn.disabled = false;
        }
      }
    });

    // Handle successful payment completion
    async function handleSuccessfulPayment(response, method, amount) {
      try {
        // Hide QR modal if it's open
        qrModal.style.display = 'none';
        
        // Get payment details
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        
        // Extract number from duration text
        let durationMin;
        if (durationText.includes('min')) {
          durationMin = parseInt(durationText.match(/\d+/)[0]);
        } else if (durationText.includes('hour')) {
          if (durationText.includes('1.5')) {
            durationMin = 90;
          } else {
            durationMin = parseInt(durationText.match(/\d+/)[0]) * 60;
          }
        } else {
          durationMin = parseInt(localStorage.getItem('selectedDuration'));
        }
        
        const players = localStorage.getItem('selectedControllers') || '1';
        
        // Calculate end time for booking
        const endTime = Date.now() + (durationMin * 60 * 1000);
        
        // Get the photo data URL
        const photoDataUrl = capturePhoto();
        
        // Create unique ID for this booking
        const bookingId = `${consoleName}-${endTime}`;
        
        // Store the photo locally
        const photosJSON = localStorage.getItem('userPhotos') || '{}';
        let photos;
        try {
          photos = JSON.parse(photosJSON);
        } catch (e) {
          photos = {};
        }
        photos[bookingId] = photoDataUrl;
        localStorage.setItem('userPhotos', JSON.stringify(photos));
        
        // Store booking in the multi-booking format
        const newBooking = {
          console: consoleName,
          consoleId: 4, // For PS5 #4
          endTime: endTime,
          minutes: durationMin,
          method: method,
          players: players,
          amount: amount,
          transactionId: response ? response.razorpay_payment_id : null,
          timestamp: "2025-08-09 14:47:34", // Updated timestamp
          user: 'Azonix07' // Updated username
        };
        
        // Use storage event to communicate between tabs
        localStorage.setItem('newBooking', JSON.stringify(newBooking));
        
        // Also store directly in consoleBookings
        const bookingsJSON = localStorage.getItem('consoleBookings') || '[]';
        let bookings = JSON.parse(bookingsJSON);
        
        // Remove any existing booking for this console
        bookings = bookings.filter(b => b.console !== consoleName);
        
        // Add the new booking
        bookings.push(newBooking);
        
        // Save updated bookings
        localStorage.setItem('consoleBookings', JSON.stringify(bookings));
        
        // Activate PS5 #4 via Firebase
        let deviceActivated = false;
        if (deviceControlConnected) {
          // Try to activate the device using Firebase
          deviceActivated = await activatePS5(durationMin);
        }
        
        // Show enhanced success overlay
        const successOverlay = document.createElement('div');
        successOverlay.className = 'success-overlay';
        
        // Calculate session end time
        const sessionEndDate = new Date(endTime);
        const hours = sessionEndDate.getHours().toString().padStart(2, '0');
        const minutes = sessionEndDate.getMinutes().toString().padStart(2, '0');
        
        successOverlay.innerHTML = `
          <div class="success-container">
            <div class="success-check"></div>
            <div class="success-title">Payment Successful!</div>
            <div class="success-message">Your gaming session has been confirmed.</div>
            
            <div class="success-details">
              <div class="success-detail-row">
                <div class="success-detail-label">Device</div>
                <div class="success-detail-value">${consoleName} #4</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Duration</div>
                <div class="success-detail-value">${durationText}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">End Time</div>
                <div class="success-detail-value">${hours}:${minutes}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Amount Paid</div>
                <div class="success-detail-value">₹${amount}</div>
              </div>
              <div class="success-detail-row">
                <div class="success-detail-label">Device Status</div>
                <div class="success-detail-value">${deviceActivated ? "Powered On" : "Manual Activation Required"}</div>
              </div>
            </div>
            
            <div class="success-redirect">Redirecting to home screen...</div>
          </div>
        `;
        
        document.body.appendChild(successOverlay);
        
        // Stop camera stream
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        
        // Clean up Firebase listeners
        if (currentPaymentId) {
          removePaymentListeners(currentPaymentId);
          currentPaymentId = null;
        }
        
        // Stop auto payment checker if it's running
        if (autoPaymentCheckTimer) {
          clearInterval(autoPaymentCheckTimer);
          autoPaymentCheckTimer = null;
        }
        
        // Redirect after a delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
        
      } catch (err) {
        console.error('Payment processing error:', err);
        showStatusMessage(`Payment processing error: ${err.message}. Please contact support.`, 'error');
      }
    }

    // Back button handler
    backBtn.addEventListener('click', () => {
      // Stop camera stream if it's active
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      // Clean up Firebase listeners
      if (currentPaymentId) {
        removePaymentListeners(currentPaymentId);
        currentPaymentId = null;
      }
      
      // Stop auto payment checker if it's running
      if (autoPaymentCheckTimer) {
        clearInterval(autoPaymentCheckTimer);
        autoPaymentCheckTimer = null;
      }
      
      // Go back to duration selection
      window.location.href = 'duration.html';
    });

    // Show status message
    function showStatusMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = 'block';
      
      // Hide after 5 seconds
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    // Initialize page
    window.onload = function() {
      // First initialize payment details
      initPaymentDetails();
      
      // Then initialize camera
      setTimeout(initCamera, 500);
      
      // Setup direct complete listener for ESP32 integration
      setupDirectCompleteListener();
      
      // Check device control status
      setTimeout(() => {
        checkDeviceStatus();
      }, 1000);
    };
  </script>
</body>
</html>
